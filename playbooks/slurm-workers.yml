---
# ===== Playbook de configuracion para los workers =====
  
- name: Configuraciones especificas de los workers
  hosts: workers
  become: yes
  gather_facts: yes
  
  tasks:
    # Sincronizacion de hora con el headnode
    - name: Configurar Chrony como cliente del Headnode
      template:
        src: /etc/ansible/templates/chrony_client.conf.j2
        dest: /etc/chrony/chrony.conf
        owner: root
        group: root
        mode: '0644'
      notify: Reiniciar chrony
      tags: chrony_client

    # Distribucion de llaves generados en el headnode 
    - name: Distribuir llave Munge desde el controlador
      copy:
        src: /etc/ansible/playbooks/buffer/munge.key
        dest: /etc/munge/munge.key
        owner: munge
        group: munge
        mode: '0400'
      tags: llaves_munge_workers
    - name: Iniciar servicio Munge en workers
      service:
        name: munge
        state: started
        enabled: yes
      tags: llaves_munge_workers
    - name: Agregar llave SSH publica para ingresar como root a los workers
      authorized_key:
        user: root
        state: present
        key: "{{ lookup('file', '/etc/ansible/playbooks/buffer/headnode_root_key.pub') }}"
      tags: llaves_ssh_workers
    
    # Gestion de recursos (Cgroups)
    - name: Distribuir configuraci√≥n de Cgroups
      template:
        src: /etc/ansible/templates/cgroup.conf.j2
        dest: /etc/slurm-llnl/cgroup.conf
        owner: slurm
        group: slurm
        mode: '0644'
      notify: Reiniciar slurmd
      tags: slurm_conf

    # Configuracion del NFS Client
    - name: Crear puntos de montaje locales
      file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - /nfs/general
        - /nfs/privileged
      tags: nfs_mount
    - name: Montar NFS /nfs/general
      mount:
        path: /nfs/general
        src: "{{ hostvars[groups['headnode'][0]]['ansible_host'] }}:/nfs/general"
        fstype: nfs
        opts: auto,nofail,noatime,nolock,intr,tcp,actimeo=1800
        state: mounted
      tags: nfs_mount
    - name: Montar NFS /nfs/privileged
      mount:
        path: /nfs/privileged
        src: "{{ hostvars[groups['headnode'][0]]['ansible_host'] }}:/nfs/privileged"
        fstype: nfs
        opts: auto,nofail,noatime,nolock,intr,tcp,actimeo=1800
        state: mounted
      tags: nfs_mount
    
    # Iniciar del daemon de Slurm
    - name: Iniciar servicio Slurmd (Worker Daemon)
      service:
        name: slurmd
        state: started
        enabled: yes
      tags: slurmd_start_workers
    
  handlers:
    - name: Reiniciar chrony
      service:
        name: chrony
        state: restarted
    - name: Reiniciar munge
      service:
        name: munge
        state: restarted
    - name: Reiniciar slurmd
      service:
        name: slurmd
        state: restarted

  post_tasks:
    - name: Mensaje final de configuracion de los workers
      debug:
        msg:
          - "========================================="
          - "Configuracion de los Workers Completada"
          - "========================================="